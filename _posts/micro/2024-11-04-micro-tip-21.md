---
layout: post
title: "자잘한 도움말 #21 querySelector의 인자에 \"#1\"을 넣었더니 고장이 납니다."
subtitle: "블로그 목차(ToC)를 만드는 중 겪은 문제"
description: "CSS escape에 대하여"
date: 2024-11-04 18:00:00 +0900
category: micro

id: 21
slug: css-escape
tags: [💡, Front-end, CSS]

coverImage: "/assets/blog/coverImages/micro-21.png"

ogImage:
  url: "/assets/blog/coverImages/micro-21.png"
---

## TL;DR

- Web API `Document.querySelector()`: 인자로 전달 받은 CSS 선택자와 일치하는 현재 웹 페이지 내 엘리먼트를 반환한다.
- 그런데 다음과 같은 선택자를 입력할 경우 오류가 발생한다.
```html
<h2 id="1. 블로그">1. 블로그</h2>
```
```javascript
document.querySelector("#1. 블로그");
// => 구문 오류! ['#1' is not a valid selector.]
```

<p class="center">
<img src="https://i.postimg.cc/J0gZL8qY/image.png" alt="error"/>
</p>

- Web API `CSS.escape()`를 사용해 문제를 해결할 수 있다.
```javascript
CSS.escape("1. 블로그");
// 문자열을 다음으로 변환: "\\31 \\.\\ 블로그"

document.querySelector(CSS.escape("1. 블로그"));
```
- `CSS.escape()`는 자동으로 문자열에 이스케이프 시퀀스(Escape Sequence)를 적용하는 유틸 함수다.

## 이하 그리 중요하진 않은 내용들

### 배경

지난번 글에 이어 이번 글도 블로그를 개편하면서 겪었던 문제를 주제로 한다. 요즘 달리 개인 프로젝트를 진행할 짬이 안 나는 시기를 보내는 중이기 때문에 이 블로그 개편 작업을 화수분으로 삼아 계속 글을 뽑아내야 할 듯. 아무튼 오늘 이야기해 볼 것은 `querySelector`와 CSS 선택자.

<p class="center">
<img src="https://i.postimg.cc/brbfjTQv/image.png" alt="toc" />
</p>

지금 글을 뷰포트 크기 768px 이상 환경에서 보고 있는 사람이라면 웹 페이지 우측에 화면 스크롤을 따라 떠다니는 글자 뭉치들을 확인할 수 있을 것이다. 현재 보고 있는 문단의 제목이 강조되어 있고, 마우스로 항목을 클릭하면 해당 문단으로 자동 스크롤을 해주는 유용한 컴포넌트. 바로 이 글의 <strong>목차</strong>다. 이걸 좀 더 유식한 척 영어로 표현하자면 "Floating <strong>Table of Contents(ToC)</strong>".

사실 이건 <a href="https://github.com/anteater333/Anteater_lab_v2">Jekyll 기반이었던 이전 버전의 블로그</a>에서도 있었던 기능이다. 다만 직접 구현은 아니었고, <a href="https://github.com/allejo/jekyll-toc">외부 패키지</a>를 <a href="https://github.com/anteater333/Anteater_lab_v2/blob/main/docs/_includes/toc.html">사용</a>했었다. 그리고 새 블로그의 프레임워크가 Next.js로 결정되며 이 패키지를 더이상 쓰기 어려워진 상황이 찾아오자 이참에 ToC 기능 정도는 직접 구현해봐야겠다 싶더라고.

### 증상

ToC 기능의 구현 방법에 대해  
블로그 글은 .md 파일 형태로 작성  
변환 모듈에 의해 블로그 빌드시 .md 파일은 html 코드로 자동 변환됨  
PostBody 컴포넌트에 변환된 HTML이 삽입되는 구조  
PostBody는 삽입된 HTML에서 Heading Element들의 정보를 추출해 PostToC에게 전달한다.  
(text, id, level(depth))  
PostToC 컴포넌트는 전달받은 Heading Element 정보 리스트를 사용해 ToC를 생성  

ToC는 다음 기능을 가지고 있다.
- ToC의 아이템을 클릭하면 해당 문단으로 이동한다.
- 현재 스크롤 위치에 따라 사용자가 읽고 있는 문단의 제목을 강조한다.


근데 "### 1. 블로그" 이런 heading을 인식하지 못하는 문제 발생

### 원인

쿼리 셀렉터(querySelectorAll)에서 발생한 문제
쿼리 셀렉터에 대한 설명

### 해결

우선 이렇게 고쳐주면 된다
(수정 코드)

### 분석

CSS Escape란? -> 아주 간단한 문자열 변환 함수

그 외 CSS 인터페이스와 static methods
https://developer.mozilla.org/ko/docs/Web/API/CSS

## 내가 배운 것

- ToC 기능을 만드는 방법
- 쿼리 셀렉터
- Web API CSS 인터페이스
- CSS Escape

----

- CSS escape란?
    - #1 을 쿼리 셀렉터에 넣으면 고장난다.
    - https://stackoverflow.com/questions/20306204/using-queryselector-with-ids-that-are-numbers

- 
- CSS Web API에 대해 알아보자


----


## 요주의 코드

```jsx
type ToCItem = {
  text: string;
  id: string;
  level: number;
};

function PostToC({ headings }: { headings: ToCItem[] }) {
  const [current, setCurrent] = useState(-1);

  /* 현재 heading 강조 기능 */
  useEffect(() => {
    if (headings.length === 0) return;

    const headingEls = document.querySelectorAll(
      headings.map((h) => `#${CSS.escape(h.id)}`).join(", ")
    );

    const observer = new IntersectionObserver(
      ([entry]) => {
        if (entry.isIntersecting) {
          setCurrent(headings.findIndex((h) => h.id === entry.target.id));
        }
      },
      {
        root: null,
        rootMargin: "0% 0% -66% 0%",
        threshold: 1,
      }
    );

    headingEls.forEach((el) => observer.observe(el));

    return () => observer.disconnect();
  }, [headings.length]);

  return (
    <PostToCNav className="toc-rail">
      <div className="toc-container">
        <ul className="toc-core">
          {headings.length > 0
            ? headings.map((heading, idx) => {
                return (
                  <li
                    key={`post-toc-item-${idx}`}
                    className={`${idx === current ? "current-heading" : ""}`}
                  >
                    {Array.from(Array(heading.level), (e, jdx) => {
                      return (
                        <p
                          className="toc-indent"
                          key={`toc-indent-${idx}-${jdx}`}
                        ></p>
                      );
                    })}
                    <a href={`#${heading.id}`}>{heading.text}</a>
                  </li>
                );
              })
            : undefined}
        </ul>
      </div>
    </PostToCNav>
  );
}
```