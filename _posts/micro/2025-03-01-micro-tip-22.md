---
layout: post
title: "자잘한 도움말 #22 Next.js에서 서버와 클라이언트의 괴리감 처리하기"
subtitle: "Hydration Mismatch"
description: ""
date: 2025-03-17 08:40:00 +0900
category: micro

id: 22
slug: hydration-mismatch
tags: [💡, Front-end, Next.js]

coverImage: "/assets/blog/coverImages/micro-21.png"

ogImage:
  url: "/assets/blog/coverImages/micro-21.png"
---

- Hydration Mismatch
    - Next.js 사용 시 문제
    - 대표적으로 new Date()
    - https://blog.hwahae.co.kr/all/tech/13604
    - 무시할 수 있는 hydration mismatch new Date
    - 무시할 수 없는 hydration mismatch 테마 (store 초기 설정시 로컬 스토리지에 저장된 테마 가져오는 코드에서 발생한 문제, 83ec7fb67b21fb3ebf32ec49e6c1a60ba66f6b67 커밋 참고)


```tsx
import { format } from "date-fns";

type Props = {
  dateString: string;
};

const DateFormatter = ({ dateString }: Props) => {
  // Safari의 parsing 알고리즘이 유독 저열하기 때문에 전처리
  const date = new Date(
    Date.parse(dateString.replace(" ", "T").replace(" ", ""))
  );

  return (
    <time dateTime={dateString} suppressHydrationWarning>
      {format(date, "LLLL	d, yyyy")}
    </time>
  );
};

export default DateFormatter;
```

```ts
import { useEffect } from "react";
import { create } from "zustand";
import { persist } from "zustand/middleware";

type Store = {
  isDarkMode: boolean;
  toggleDark: () => void;
  setIsDarkMode: (isDarkMode: boolean) => void;
};

const useStore = create<Store>()(
  persist(
    (set) => ({
      isDarkMode: false,
      toggleDark: () => set((state) => ({ isDarkMode: !state.isDarkMode })),
      setIsDarkMode: (isDarkMode) => set((state) => ({ isDarkMode })),
    }),
    { name: "theme-storage" }
  )
);

export const useMatchMedia = () => {
  const { setIsDarkMode } = useStore();

  // useStore에서 바로 window 객체의 존재 여부를 파악하며 isDarkMode를 결정지을 경우
  // 서버사이드 렌더링과 클라이언트 사이드 렌더링의 초기 상태 차이로 인해 오류를 발생시킴
  // 먼저 상태 생성 후 -> useEffect 훅으로 시스템 설정을 확인
  useEffect(() => {
    const mediaQueryList = window.matchMedia("(prefers-color-scheme: dark)");
    const updateDarkMode = (e: MediaQueryListEvent) => {
      setIsDarkMode(e.matches);
    };

    // 로컬 스토리지에 저장된 테마 상태값이 없다면 시스템 설정을 가져온다.
    if (!localStorage.getItem("theme-storage"))
      setIsDarkMode(mediaQueryList.matches);

    // 리스너 등록
    mediaQueryList.addEventListener("change", updateDarkMode);

    // 컴포넌트 언마운트 시 리스너 제거
    return () => {
      mediaQueryList.removeEventListener("change", updateDarkMode);
    };
  }, []);
};

export const useDarkMode = () => {
  const { isDarkMode, toggleDark } = useStore();

  return { isDarkMode, toggleDark };
};

export default useStore;
```

## TL;DR

## 이하 그리 중요하진 않은 내용들

## 내가 배운 것
