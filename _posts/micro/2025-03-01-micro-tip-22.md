---
layout: post
title: "자잘한 도움말 #22 Next.js에서 서버와 클라이언트의 괴리감 처리하기"
subtitle: "Hydration Mismatch란 무엇인가"
description: ""
date: 2025-03-17 08:40:00 +0900
category: micro

id: 22
slug: hydration-mismatch
tags: [💡, Front-end, Next.js]

coverImage: "/assets/blog/coverImages/micro-22.png"

ogImage:
  url: "/assets/blog/coverImages/micro-22.png"
---

- Hydration Mismatch
    - Next.js 사용 시 문제
    - 대표적으로 new Date()
    - 무시할 수 있는 hydration mismatch new Date
    - 무시할 수 없는 hydration mismatch 테마 (store 초기 설정시 로컬 스토리지에 저장된 테마 가져오는 코드에서 발생한 문제, 83ec7fb67b21fb3ebf32ec49e6c1a60ba66f6b67 커밋 참고) -> 이건 보류
- `suppressHydrationWarning` 한 줄 추가로 해결 가능하다. (하지만 이건 에러를 무시하는 방법?)
- 클라이언트에서만 결과가 나오도록 만든다? (훅을 사용해서)
- 하이드레이션이란?? -> Hack the terms로 가려다가 그냥 여기서 다뤄보면 좋을 것 같음

- 서버에 있는 렌더링된 결과 vs 클라이언트에서 렌더링된 결과가 서로 달라서 생기는 문제

- 왜 문제가 되는가?? (by copilot)  

```
Hydration mismatch는 서버에서 렌더링된 HTML과 클라이언트에서 React가 초기화될 때 생성된 HTML이 일치하지 않을 때 발생합니다. 이는 여러 가지 문제를 일으킬 수 있습니다:

사용자 경험 문제:

사용자가 페이지를 로드할 때 깜빡임이나 레이아웃이 갑자기 변경되는 현상이 발생할 수 있습니다. 이는 사용자 경험을 저하시킬 수 있습니다.
SEO 문제:

서버에서 렌더링된 HTML이 검색 엔진에 의해 인덱싱되기 때문에, 클라이언트 측에서 다른 HTML이 렌더링되면 검색 엔진이 잘못된 정보를 인덱싱할 수 있습니다.
디버깅 어려움:

Hydration mismatch는 디버깅하기 어려운 문제 중 하나입니다. 서버와 클라이언트의 상태가 다를 때 발생할 수 있는 문제를 추적하고 해결하는 데 많은 시간이 소요될 수 있습니다.
성능 문제:

Hydration mismatch가 발생하면 React는 클라이언트 측에서 전체 DOM을 다시 렌더링해야 할 수 있습니다. 이는 성능 저하를 초래할 수 있습니다.
이를 방지하기 위해 서버와 클라이언트에서 동일한 상태와 데이터를 사용하여 일관된 HTML을 생성하는 것이 중요합니다. 예를 들어, 서버에서 데이터를 가져와 렌더링할 때와 클라이언트에서 동일한 데이터를 사용하여 렌더링할 때 일관성을 유지해야 합니다.

다음은 Hydration mismatch를 방지하기 위한 몇 가지 팁입니다:

동일한 데이터 소스 사용:

서버와 클라이언트 모두 동일한 데이터 소스를 사용하여 렌더링합니다.
조건부 렌더링 최소화:

서버와 클라이언트에서 조건부 렌더링을 최소화하여 일관된 HTML을 생성합니다.
동일한 상태 관리:

서버와 클라이언트에서 동일한 상태 관리 라이브러리를 사용하여 상태를 일관되게 유지합니다.
환경 변수 사용:

서버와 클라이언트에서 동일한 환경 변수를 사용하여 일관된 설정을 유지합니다.
이러한 방법을 통해 Hydration mismatch 문제를 방지하고, 서버와 클라이언트에서 일관된 HTML을 생성할 수 있습니다.
```


https://nextjs.org/docs/messages/react-hydration-error

- A server/client branch `if (typeof window !== 'undefined')`.
- Variable input such as `Date.now()` or `Math.random()` which changes each time it's called.
- Date formatting in a user's locale which doesn't match the server.
- External changing data without sending a snapshot of it along with the HTML.
- Invalid HTML tag nesting.

- 근데 왜 SSG에서 이런 에러가 떴을까? (빌드 후에도 콘솔에 출력되는 에러 Minified React error #418)



```tsx
import { format } from "date-fns";

type Props = {
  dateString: string;
};

const DateFormatter = ({ dateString }: Props) => {
  // Safari의 parsing 알고리즘이 유독 저열하기 때문에 전처리
  const date = new Date(
    Date.parse(dateString.replace(" ", "T").replace(" ", ""))
  );

  return (
    <time dateTime={dateString} suppressHydrationWarning>
      {format(date, "LLLL	d, yyyy")}
    </time>
  );
};

export default DateFormatter;
```

<strong>[참고자료들]</strong>


- https://ui.toast.com/weekly-pick/ko_20210119

궁금한게있는데
Hydration Mismatch는 서버 컴포넌트 때문인가 SSR 때문인가.

- https://developer-haru.tistory.com/81  
이 글 상당히 좋은데?

- https://blog.hwahae.co.kr/all/tech/13604

## TL;DR

- Hydration이란 ~~
- ~~로 인해 Hydration Mismatch가 발생한다
- Hydration Mismatch를 해결하는 방법
- Hydration Mismatch를 무시하는 방법

## 이하 그리 중요하진 않은 내용들

호기롭게 시작을 세상에 공표했던 개인 프로젝트는 아직까지 지지부진해 첫 삽도 뜨지 못한 가운데, 아무런 새 글도 없이 블로그가 죽은 것 처럼 보이면 신세가 참 처량해 보이겠다 싶어 이번에도 자잘한 도움말을 써보려 시도하고있다. 그런 고로 이번에도 주제는 블로그 리모델링 중 있었던 일이다. 아니 블로그 재개발도 어느덧 벌써 반년 전의 일이 되어버렸는데 언제까지 이걸 울궈먹을런지.

### SSR과 CSR

나는 이 블로그를 React와 Next.js 프레임워크를 사용해 구축했다. 얼마 전 알게된 사실인데 CRA(`create-react-app`)이 deprecated 처리된 이후 React 공식 문서에선 새 React 앱을 만들 땐 Next.js를 사용할 것을 권장하고 있더라고. 아니 왜 Vite 놔두고 그런담.

[위 내용에 대한 사진]

내 블로그도 Next.js로 만든 주제에 몽니를 부리고 있지만, 이건 Next.js의 장점이 꼭 필요했기 때문이라구. Next.js와 같은 프레임워크를 사용하지 않고 리액트 라이브러리와 Vite나 Rollup 같은 번들러로 사이트를 만들면 일반적으로 클라이언트에서 HTML의 생성이 이루어지는 CSR(Client Side Rendering) 방식의 SPA(Single Page Application)로 결과물이 나올 것이다. SPA는 수많은 현대 웹 기반 서비스들의 가능성을 넓혀준 패러다임이지만, 근본적인 문제가 하나 있다. 클라이언트에서 사이트를 생성한다는 것은 클라이언트가 그럴 능력을 갖추고 있어야 한다는 것이다. 일반 사용자들이 사용하는 웹 브라우저에겐 그 능력이 기본적으로 내장되어 있지만, 웹 서핑은 웹 브라우저로만 하는 것은 아니다. (웹 크롤러 내용 추가)

Next.js로 만든 블로구

Next.js 왜 쓰십니까

SSR과 CSR 지난번에 설명한 적 있는 것 같은데
서버 컴포넌트? 클라이언트 컴포넌트?

### Hydration

매마른 정적 페이지에 물을 뿌리자

### Hydration Mismatch

서버가 생각한 페이지의 상태 vs 실제로 사용자가 받은 상태

그럼 Next.js SSG로 제공한 서비스는 어떻게 그걸 알아차리는거지...?
  - 이 부분에선 가설을 세워보고 제대로 찾아볼것
  - 예를들면, 사용자가 제공받은 최초 페이지는 최초 렌더링이 되어있는 상태로 들어있다던가...


해결법 설명

서버의 상태와 동일하게 맞추기, `suppressHydrationWarning`

## 내가 배운 것
